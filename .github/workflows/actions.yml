name: CI Tests

# Pull request will trigger when PR is opened or updated, and more (https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#pull_request)
# Thus limit push checks to master branch so things run after the PR is merged. Without the limit multiple actions run on each PR
on:
  pull_request:
  push:
    branches:
      - 'master'

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          # To use with eslint script
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run linting (Prettier + ESLint)
        run: npm run lint:check

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm run test:ci

      - name: Save PR coverage
        if: github.event_name == 'pull_request'
        run: cp packages/server/coverage/coverage-summary.json coverage-pr.json

      - name: Switch to base branch and get base coverage
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git reset --hard HEAD
          git clean -fd
          git checkout origin/${{ github.base_ref }}
          npm install
          npm run test:ci || echo "Base branch tests failed, will skip delta"
          if [ -f "packages/server/coverage/coverage-summary.json" ]; then
            cp packages/server/coverage/coverage-summary.json coverage-base.json
          else
            echo '{"total":{"lines":{"pct":0},"statements":{"pct":0},"functions":{"pct":0},"branches":{"pct":0}}}' > coverage-base.json
          fi          git reset --hard HEAD
          git clean -fd          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          git checkout pr-branch

      - name: Upload Jest Coverage Report
        if: success()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage
          path: packages/server/coverage

      - name: Generate Coverage Report with Delta
        if: github.event_name == 'pull_request'
        id: coverage
        run: |
          if [ -f "coverage-pr.json" ]; then
            PR_TOTAL=$(jq '.total' coverage-pr.json)
            PR_LINES=$(echo $PR_TOTAL | jq -r '.lines.pct')
            PR_STATEMENTS=$(echo $PR_TOTAL | jq -r '.statements.pct')
            PR_FUNCTIONS=$(echo $PR_TOTAL | jq -r '.functions.pct')
            PR_BRANCHES=$(echo $PR_TOTAL | jq -r '.branches.pct')
            
            BASE_TOTAL=$(jq '.total' coverage-base.json)
            BASE_LINES=$(echo $BASE_TOTAL | jq -r '.lines.pct')
            BASE_STATEMENTS=$(echo $BASE_TOTAL | jq -r '.statements.pct')
            BASE_FUNCTIONS=$(echo $BASE_TOTAL | jq -r '.functions.pct')
            BASE_BRANCHES=$(echo $BASE_TOTAL | jq -r '.branches.pct')
            
            # Calculate deltas using awk instead of bc for better compatibility
            LINES_DELTA=$(awk "BEGIN {printf \"%.2f\", $PR_LINES - $BASE_LINES}")
            STATEMENTS_DELTA=$(awk "BEGIN {printf \"%.2f\", $PR_STATEMENTS - $BASE_STATEMENTS}")
            FUNCTIONS_DELTA=$(awk "BEGIN {printf \"%.2f\", $PR_FUNCTIONS - $BASE_FUNCTIONS}")
            BRANCHES_DELTA=$(awk "BEGIN {printf \"%.2f\", $PR_BRANCHES - $BASE_BRANCHES}")
            
            # Format delta with + sign for positive values
            format_delta() {
              if [ $(echo "$1 >= 0" | awk '{print ($1 >= 0)}') -eq 1 ]; then
                echo "+$1"
              else
                echo "$1"
              fi
            }
            
            LINES_DELTA_FMT=$(format_delta "$LINES_DELTA")
            STATEMENTS_DELTA_FMT=$(format_delta "$STATEMENTS_DELTA")
            FUNCTIONS_DELTA_FMT=$(format_delta "$FUNCTIONS_DELTA")
            BRANCHES_DELTA_FMT=$(format_delta "$BRANCHES_DELTA")
            
            cat << 'EOF' > coverage-report.md
          ## ðŸ“Š Server Code Coverage Report

          | Metric | Coverage | Delta |
          |--------|----------|-------|
          EOF
            
            echo "| Lines | ${PR_LINES}% | ${LINES_DELTA_FMT}% |" >> coverage-report.md
            echo "| Statements | ${PR_STATEMENTS}% | ${STATEMENTS_DELTA_FMT}% |" >> coverage-report.md
            echo "| Functions | ${PR_FUNCTIONS}% | ${FUNCTIONS_DELTA_FMT}% |" >> coverage-report.md
            echo "| Branches | ${PR_BRANCHES}% | ${BRANCHES_DELTA_FMT}% |" >> coverage-report.md
            echo "" >> coverage-report.md
            echo "### ðŸŽ¯ Coverage Delta" >> coverage-report.md
            echo "This PR changes the overall server code coverage." >> coverage-report.md
            
            cat coverage-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          path: coverage-report.md

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run ci-build

  integrationTests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, test, build]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run integration tests
        run: npm run test:integration
