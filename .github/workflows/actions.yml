name: CI Tests

# Pull request will trigger when PR is opened or updated, and more (https://docs.github.com/en/actions/writing-workflows/choosing-when-your-workflow-runs/events-that-trigger-workflows#pull_request)
# Thus limit push checks to master branch so things run after the PR is merged. Without the limit multiple actions run on each PR
on:
  pull_request:
  push:
    branches:
      - 'master'

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          # To use with eslint script
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run linting (Prettier + ESLint)
        run: npm run lint:check

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm run test:ci

      - name: Save PR coverage
        if: github.event_name == 'pull_request'
        run: cp packages/server/coverage/coverage-summary.json coverage-pr.json

      - name: Switch to base branch and get base coverage
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}
          git reset --hard HEAD
          git clean -fd
          git checkout origin/${{ github.base_ref }}
          npm install
          npm run test:ci || echo "Base branch tests failed, will skip delta"
          if [ -f "packages/server/coverage/coverage-summary.json" ]; then
            cp packages/server/coverage/coverage-summary.json coverage-base.json
          else
            echo '{"total":{"lines":{"pct":0},"statements":{"pct":0},"functions":{"pct":0},"branches":{"pct":0}}}' > coverage-base.json
          fi          git reset --hard HEAD
          git clean -fd          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          git checkout pr-branch

      - name: Upload Jest Coverage Report
        if: success()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage
          path: packages/server/coverage

      - name: Generate Coverage Report with Delta
        if: github.event_name == 'pull_request'
        id: coverage
        run: |
          if [ -f "coverage-pr.json" ]; then
            PR_TOTAL=$(jq '.total' coverage-pr.json)
            PR_LINES=$(echo $PR_TOTAL | jq -r '.lines.pct')
            PR_STATEMENTS=$(echo $PR_TOTAL | jq -r '.statements.pct')
            PR_FUNCTIONS=$(echo $PR_TOTAL | jq -r '.functions.pct')
            PR_BRANCHES=$(echo $PR_TOTAL | jq -r '.branches.pct')
            
            BASE_TOTAL=$(jq '.total' coverage-base.json)
            BASE_LINES=$(echo $BASE_TOTAL | jq -r '.lines.pct')
            BASE_STATEMENTS=$(echo $BASE_TOTAL | jq -r '.statements.pct')
            BASE_FUNCTIONS=$(echo $BASE_TOTAL | jq -r '.functions.pct')
            BASE_BRANCHES=$(echo $BASE_TOTAL | jq -r '.branches.pct')
            
            # Calculate deltas
            LINES_DELTA=$(echo "$PR_LINES - $BASE_LINES" | bc)
            STATEMENTS_DELTA=$(echo "$PR_STATEMENTS - $BASE_STATEMENTS" | bc)
            FUNCTIONS_DELTA=$(echo "$PR_FUNCTIONS - $BASE_FUNCTIONS" | bc)
            BRANCHES_DELTA=$(echo "$PR_BRANCHES - $BASE_BRANCHES" | bc)
            
            # Format delta with + sign for positive values
            format_delta() {
              if (( $(echo "$1 > 0" | bc -l) )); then
                echo "+$1"
              else
                echo "$1"
              fi
            }
            
            LINES_DELTA_FMT=$(format_delta $LINES_DELTA)
            STATEMENTS_DELTA_FMT=$(format_delta $STATEMENTS_DELTA)
            FUNCTIONS_DELTA_FMT=$(format_delta $FUNCTIONS_DELTA)
            BRANCHES_DELTA_FMT=$(format_delta $BRANCHES_DELTA)
            
            # Calculate coverage for changed lines only
            git fetch origin ${{ github.base_ref }}
            
            # Get list of changed .ts/.js files in packages/server/src
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^packages/server/src/.*\.\(ts\|js\)$' || true)
            
            if [ ! -z "$CHANGED_FILES" ] && [ -f "packages/server/coverage/lcov.info" ]; then
              TOTAL_NEW_LINES=0
              COVERED_NEW_LINES=0
              
              for file in $CHANGED_FILES; do
                # Get added/modified line numbers for this file
                CHANGED_LINE_NUMBERS=$(git diff origin/${{ github.base_ref }}...HEAD "$file" | grep -E '^\+[^+]' | cat -n | awk '{print $1}' || true)
                
                if [ ! -z "$CHANGED_LINE_NUMBERS" ]; then
                  # Parse lcov.info for this file's coverage
                  # This is a simplified version - full implementation would need more robust parsing
                  FILE_COVERAGE=$(grep -A 1000 "SF:.*$file" packages/server/coverage/lcov.info | grep -B 1000 "end_of_record" | grep "^DA:" || true)
                  
                  while IFS= read -r line_num; do
                    TOTAL_NEW_LINES=$((TOTAL_NEW_LINES + 1))
                    # Check if this line is in coverage report and was executed
                    if echo "$FILE_COVERAGE" | grep -q "^DA:$line_num,[1-9]"; then
                      COVERED_NEW_LINES=$((COVERED_NEW_LINES + 1))
                    fi
                  done <<< "$CHANGED_LINE_NUMBERS"
                fi
              done
              
              if [ $TOTAL_NEW_LINES -gt 0 ]; then
                NEW_LINES_COV=$(echo "scale=2; ($COVERED_NEW_LINES * 100) / $TOTAL_NEW_LINES" | bc)
              else
                NEW_LINES_COV="N/A"
              fi
            else
              NEW_LINES_COV="N/A"
            fi
            
            cat << EOF > coverage-report.md
          ## ðŸ“Š Server Code Coverage Report

          | Metric | Coverage | Delta |
          |--------|----------|-------|
          | Lines | ${PR_LINES}% | ${LINES_DELTA_FMT}% |
          | Statements | ${PR_STATEMENTS}% | ${STATEMENTS_DELTA_FMT}% |
          | Functions | ${PR_FUNCTIONS}% | ${FUNCTIONS_DELTA_FMT}% |
          | Branches | ${PR_BRANCHES}% | ${BRANCHES_DELTA_FMT}% |

          ### ðŸŽ¯ New/Changed Lines Coverage
          **${NEW_LINES_COV}%** of lines added or modified in this PR are covered by tests
          EOF
            
            cat coverage-report.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          path: coverage-report.md

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm run ci-build

  integrationTests:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, test, build]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: npm install

      - name: Run integration tests
        run: npm run test:integration
